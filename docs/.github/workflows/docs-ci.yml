name: Documentation CI/CD

on:
  pull_request:
    paths:
      - 'docs/**/*.md'
      - 'docs/scripts/**'
      - '.github/workflows/docs-ci.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'docs/**/*.md'
      - 'docs/scripts/**'
  schedule:
    # Run full validation daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  DOCS_ROOT: ./docs

jobs:
  validate-links:
    name: Validate Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: chmod +x docs/scripts/*.sh

      - name: Run link validation
        run: |
          cd docs
          ./scripts/validate-links.sh
        continue-on-error: false

      - name: Upload link validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: link-validation-report
          path: /tmp/link-validation-report.txt

  validate-frontmatter:
    name: Validate Front Matter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: chmod +x docs/scripts/*.sh

      - name: Run front matter validation
        run: |
          cd docs
          ./scripts/validate-frontmatter.sh
        continue-on-error: false

      - name: Upload front matter validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontmatter-validation-report
          path: /tmp/frontmatter-validation-report.txt

  validate-mermaid:
    name: Validate Mermaid Diagrams
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: chmod +x docs/scripts/*.sh

      - name: Run Mermaid validation
        run: |
          cd docs
          ./scripts/validate-mermaid.sh
        continue-on-error: false

      - name: Upload Mermaid validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mermaid-validation-report
          path: /tmp/mermaid-validation-report.txt

  detect-ascii:
    name: Detect ASCII Diagrams
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: chmod +x docs/scripts/*.sh

      - name: Run ASCII detection
        run: |
          cd docs
          ./scripts/detect-ascii.sh
        continue-on-error: false

      - name: Upload ASCII detection report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ascii-detection-report
          path: /tmp/ascii-detection-report.txt

  validate-coverage:
    name: Validate Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: chmod +x docs/scripts/*.sh

      - name: Run coverage validation
        run: |
          cd docs
          ./scripts/validate-coverage.sh
        continue-on-error: true

      - name: Upload coverage validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-validation-report
          path: /tmp/coverage-validation-report.txt

  full-validation:
    name: Full Validation Suite
    runs-on: ubuntu-latest
    needs: [validate-links, validate-frontmatter, validate-mermaid, detect-ascii, validate-coverage]
    if: github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: chmod +x docs/scripts/*.sh

      - name: Run full validation suite
        run: |
          cd docs
          ./scripts/validate-all.sh

      - name: Upload combined validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: combined-validation-report
          path: /tmp/docs-validation/combined-report.md

  generate-reports:
    name: Generate Documentation Reports
    runs-on: ubuntu-latest
    needs: full-validation
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: chmod +x docs/scripts/*.sh

      - name: Generate documentation metrics
        run: |
          cd docs
          ./scripts/generate-reports.sh

      - name: Generate index
        run: |
          cd docs
          ./scripts/generate-index.sh

      - name: Upload metrics report
        uses: actions/upload-artifact@v4
        with:
          name: documentation-metrics
          path: docs/DOCUMENTATION_METRICS.md

      - name: Commit updated reports
        if: github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/DOCUMENTATION_METRICS.md docs/INDEX.md
          git diff --quiet && git diff --staged --quiet || git commit -m "docs: update documentation metrics and index [skip ci]"
          git push

  publish-metrics:
    name: Publish Metrics to GitHub Pages
    runs-on: ubuntu-latest
    needs: generate-reports
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download metrics
        uses: actions/download-artifact@v4
        with:
          name: documentation-metrics
          path: ./public

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  comment-on-pr:
    name: Comment Validation Results on PR
    runs-on: ubuntu-latest
    needs: [validate-links, validate-frontmatter, validate-mermaid, detect-ascii]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: ./reports

      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            let comment = '## üìö Documentation Validation Results\n\n';

            const reports = [
              { name: 'Link Validation', file: 'link-validation-report/link-validation-report.txt' },
              { name: 'Front Matter Validation', file: 'frontmatter-validation-report/frontmatter-validation-report.txt' },
              { name: 'Mermaid Validation', file: 'mermaid-validation-report/mermaid-validation-report.txt' },
              { name: 'ASCII Detection', file: 'ascii-detection-report/ascii-detection-report.txt' }
            ];

            for (const report of reports) {
              const reportPath = path.join('./reports', report.file);
              if (fs.existsSync(reportPath)) {
                const content = fs.readFileSync(reportPath, 'utf8');
                comment += `### ${report.name}\n\n\`\`\`\n${content}\n\`\`\`\n\n`;
              }
            }

            comment += '\n---\n\n';
            comment += '*Generated by Documentation CI/CD*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  check-documentation-size:
    name: Check Documentation Size
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate documentation size
        run: |
          TOTAL_DOCS=$(find docs -name "*.md" -type f | wc -l)
          TOTAL_WORDS=$(find docs -name "*.md" -type f -exec wc -w {} + | tail -1 | awk '{print $1}')
          TOTAL_SIZE=$(du -sh docs | awk '{print $1}')

          echo "üìä Documentation Statistics:"
          echo "- Total Documents: $TOTAL_DOCS"
          echo "- Total Words: $TOTAL_WORDS"
          echo "- Total Size: $TOTAL_SIZE"

          # Fail if documentation is too large
          SIZE_MB=$(du -sm docs | awk '{print $1}')
          if [ $SIZE_MB -gt 100 ]; then
            echo "‚ö†Ô∏è Warning: Documentation size exceeds 100MB"
            exit 1
          fi
