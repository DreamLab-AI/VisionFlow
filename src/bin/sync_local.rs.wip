// src/bin/sync_local.rs
//! Local file sync binary - syncs local baseline with GitHub delta updates

use std::sync::Arc;
use tokio::sync::RwLock;
use webxr::adapters::neo4j_adapter::{Neo4jAdapter, Neo4jConfig};
use webxr::adapters::neo4j_ontology_repository::{Neo4jOntologyRepository, Neo4jOntologyConfig};
use webxr::config::AppFullSettings;
use webxr::services::github::api::GitHubClient;
use webxr::services::github::config::GitHubConfig;
use webxr::services::github::content_enhanced::EnhancedContentAPI;
use webxr::services::local_file_sync_service::LocalFileSyncService;
use webxr::services::ontology_enrichment_service::OntologyEnrichmentService;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // Initialize logging
    env_logger::Builder::from_env(env_logger::Env::default().default_filter_or("info")).init();

    log::info!("ðŸš€ Starting local file sync with GitHub delta updates");

    // Load environment variables
    dotenvy::dotenv().ok();

    // Establish Neo4j connection using configuration
    let uri = std::env::var("NEO4J_URI").unwrap_or_else(|_| "bolt://localhost:7687".to_string());
    let user = std::env::var("NEO4J_USER").unwrap_or_else(|_| "neo4j".to_string());
    let password = std::env::var("NEO4J_PASSWORD").unwrap_or_else(|_| "password".to_string());
    let database = std::env::var("NEO4J_DATABASE").unwrap_or_else(|_| "neo4j".to_string());

    let neo4j_config = Neo4jConfig {
        uri: uri.clone(),
        user: user.clone(),
        password: password.clone(),
        database: database.clone(),
        max_connections: 100,
        connection_timeout: 30,
        connection_acquisition_timeout: 60,
    };

    let ontology_config = Neo4jOntologyConfig {
        uri,
        user,
        password,
        database,
    };

    log::info!("âœ… Configured Neo4j connections");

    // Initialize repositories
    let kg_repo = Arc::new(Neo4jAdapter::new(neo4j_config).await?);
    let onto_repo = Arc::new(Neo4jOntologyRepository::new(ontology_config).await?);

    // Get graph instance for enrichment service
    let graph = onto_repo.graph().clone();

    // Initialize GitHub client
    let github_config = GitHubConfig::from_env()?;
    let settings = Arc::new(RwLock::new(AppFullSettings::default()));
    let github_client = Arc::new(GitHubClient::new(github_config, settings).await?);

    let content_api = Arc::new(EnhancedContentAPI::new(github_client));

    // Initialize whelk inference engine for ontology reasoning
    let whelk_engine = Arc::new(webxr::adapters::whelk_inference_engine::WhelkInferenceEngine::new());
    let reasoner = Arc::new(webxr::services::ontology_reasoner::OntologyReasoner::new(
        whelk_engine,
        onto_repo.clone() as Arc<dyn webxr::ports::ontology_repository::OntologyRepository>,
    ));

    // Initialize edge classifier (no arguments needed)
    let edge_classifier = Arc::new(webxr::services::edge_classifier::EdgeClassifier::new());

    let enrichment_service = Arc::new(OntologyEnrichmentService::new(
        reasoner,
        edge_classifier,
    ));

    // Create sync service
    let sync_service = LocalFileSyncService::new(
        content_api,
        kg_repo,
        onto_repo,
        enrichment_service,
    );

    log::info!("ðŸ”„ Starting sync operation...");

    // Run sync
    let stats = sync_service.sync_with_github_delta().await?;

    // Display results
    println!("\nâœ… Sync complete!");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("ðŸ“Š Statistics:");
    println!("  â€¢ Total files scanned:      {}", stats.total_files);
    println!(
        "  â€¢ Files synced from local:  {}",
        stats.files_synced_from_local
    );
    println!(
        "  â€¢ Files updated from GitHub: {}",
        stats.files_updated_from_github
    );
    println!(
        "  â€¢ Knowledge graph files:    {}",
        stats.kg_files_processed
    );
    println!(
        "  â€¢ Ontology files processed: {}",
        stats.ontology_files_processed
    );
    println!("  â€¢ Skipped files:            {}", stats.skipped_files);
    println!("  â€¢ Duration:                 {:?}", stats.duration);
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

    if !stats.errors.is_empty() {
        println!("\nâš ï¸  Errors encountered ({}):", stats.errors.len());
        for (i, error) in stats.errors.iter().enumerate().take(10) {
            println!("  {}. {}", i + 1, error);
        }
        if stats.errors.len() > 10 {
            println!("  ... and {} more errors", stats.errors.len() - 10);
        }
    }

    log::info!("âœ… Sync binary completed successfully");

    Ok(())
}
