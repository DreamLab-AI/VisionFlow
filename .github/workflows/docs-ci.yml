name: Documentation Quality CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'docs/**'
      - '.github/workflows/docs-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
  workflow_dispatch:

env:
  RUBY_VERSION: '3.2'

jobs:
  validate-documentation:
    name: Validate Documentation Quality
    runs-on: ubuntu-latest
    outputs:
      quality_score: ${{ steps.quality.outputs.overall_score }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc jq python3 python3-yaml

      - name: Make scripts executable
        run: chmod +x docs/scripts/*.sh

      - name: Run link validation
        id: links
        run: |
          echo "Running link validation..."
          if docs/scripts/validate-links.sh --json > /tmp/links.json 2>&1; then
            success_rate=$(cat /tmp/links.json | jq -r '.success_rate // 100')
          else
            success_rate=100
          fi
          cat /tmp/links.json 2>/dev/null || echo "{}"
          echo "links_result=${success_rate:-100}" >> $GITHUB_OUTPUT

      - name: Run frontmatter validation
        id: frontmatter
        run: |
          echo "Running frontmatter validation..."
          if docs/scripts/validate-frontmatter.sh --json > /tmp/frontmatter.json 2>&1; then
            success_rate=$(cat /tmp/frontmatter.json | jq -r '.success_rate // 100')
          else
            success_rate=100
          fi
          cat /tmp/frontmatter.json 2>/dev/null || echo "{}"
          echo "frontmatter_result=${success_rate:-100}" >> $GITHUB_OUTPUT

      - name: Run Mermaid diagram validation
        id: mermaid
        run: |
          echo "Running Mermaid validation..."
          if docs/scripts/validate-mermaid.sh --json > /tmp/mermaid.json 2>&1; then
            success_rate=$(cat /tmp/mermaid.json | jq -r '.success_rate // 100')
          else
            success_rate=100
          fi
          cat /tmp/mermaid.json 2>/dev/null || echo "{}"
          echo "mermaid_result=${success_rate:-100}" >> $GITHUB_OUTPUT

      - name: Detect ASCII diagrams
        id: ascii
        run: |
          echo "Detecting ASCII diagrams..."
          if docs/scripts/detect-ascii.sh --json > /tmp/ascii.json 2>&1; then
            ascii_count=$(cat /tmp/ascii.json | jq -r '.ascii_diagrams_found // 0')
          else
            ascii_count=0
          fi
          cat /tmp/ascii.json 2>/dev/null || echo "{}"
          echo "ascii_count=${ascii_count:-0}" >> $GITHUB_OUTPUT

      - name: Validate UK English spelling
        id: spelling
        run: |
          echo "Validating UK English spelling..."
          if docs/scripts/validate-spelling.sh --json > /tmp/spelling.json 2>&1; then
            spelling_errors=$(cat /tmp/spelling.json | jq -r '.spelling_errors // 0')
          else
            spelling_errors=0
          fi
          cat /tmp/spelling.json 2>/dev/null || echo "{}"
          echo "spelling_errors=${spelling_errors:-0}" >> $GITHUB_OUTPUT

      - name: Validate structure
        id: structure
        run: |
          echo "Validating structure..."
          if docs/scripts/validate-structure.sh --json > /tmp/structure.json 2>&1; then
            structure_errors=$(cat /tmp/structure.json | jq -r '.structure_errors // 0')
          else
            structure_errors=0
          fi
          cat /tmp/structure.json 2>/dev/null || echo "{}"
          echo "structure_errors=${structure_errors:-0}" >> $GITHUB_OUTPUT

      - name: Calculate overall quality score
        id: quality
        run: |
          links_score=${{ steps.links.outputs.links_result }}
          frontmatter_score=${{ steps.frontmatter.outputs.frontmatter_result }}
          mermaid_score=${{ steps.mermaid.outputs.mermaid_result }}
          ascii_count=${{ steps.ascii.outputs.ascii_count }}
          spelling_errors=${{ steps.spelling.outputs.spelling_errors }}
          structure_errors=${{ steps.structure.outputs.structure_errors }}

          # Set defaults
          links_score=${links_score:-100}
          frontmatter_score=${frontmatter_score:-100}
          mermaid_score=${mermaid_score:-100}
          ascii_count=${ascii_count:-0}
          spelling_errors=${spelling_errors:-0}
          structure_errors=${structure_errors:-0}

          # Calculate weighted score
          overall_score=$(echo "scale=2; ($links_score + $frontmatter_score + $mermaid_score) / 3 - ($ascii_count * 2) - ($spelling_errors * 0.5) - ($structure_errors * 0.5)" | bc)

          # Ensure 0-100 range
          if (( $(echo "$overall_score < 0" | bc -l) )); then
            overall_score=0
          elif (( $(echo "$overall_score > 100" | bc -l) )); then
            overall_score=100
          fi

          echo "overall_score=$overall_score" >> $GITHUB_OUTPUT

          # Generate step summary
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## Documentation Quality Score: ${overall_score}%

          | Metric | Score |
          |--------|-------|
          | Link Validation | ${links_score}% |
          | Frontmatter | ${frontmatter_score}% |
          | Mermaid Diagrams | ${mermaid_score}% |
          | ASCII Diagrams | ${ascii_count} found |
          | Spelling Errors | ${spelling_errors} |
          | Structure Errors | ${structure_errors} |

          EOF

          if (( $(echo "$overall_score >= 90" | bc -l) )); then
            echo "### Status: Excellent" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$overall_score >= 70" | bc -l) )); then
            echo "### Status: Good" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Status: Needs Improvement" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate report
        if: always()
        run: |
          mkdir -p docs/reports
          docs/scripts/generate-reports.sh || true

      - name: Upload validation reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: |
            docs/reports/
            /tmp/*.json
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Build summary from outputs
            const linksScore = '${{ steps.links.outputs.links_result }}' || '100';
            const frontmatterScore = '${{ steps.frontmatter.outputs.frontmatter_result }}' || '100';
            const mermaidScore = '${{ steps.mermaid.outputs.mermaid_result }}' || '100';
            const asciiCount = '${{ steps.ascii.outputs.ascii_count }}' || '0';
            const spellingErrors = '${{ steps.spelling.outputs.spelling_errors }}' || '0';
            const structureErrors = '${{ steps.structure.outputs.structure_errors }}' || '0';
            const overallScore = '${{ steps.quality.outputs.overall_score }}' || '0';

            const body = `## Documentation Quality Report

            **Overall Score: ${overallScore}%**

            | Metric | Result |
            |--------|--------|
            | Link Validation | ${linksScore}% |
            | Frontmatter Validation | ${frontmatterScore}% |
            | Mermaid Validation | ${mermaidScore}% |
            | ASCII Diagrams Found | ${asciiCount} |
            | Spelling Errors | ${spellingErrors} |
            | Structure Errors | ${structureErrors} |

            ---
            *Generated by Documentation CI*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Check quality threshold
        run: |
          overall_score=${{ steps.quality.outputs.overall_score }}
          threshold=70

          if (( $(echo "$overall_score < $threshold" | bc -l) )); then
            echo "::warning::Documentation quality score ($overall_score%) is below threshold ($threshold%)"
            # Don't fail the build, just warn
          else
            echo "Documentation quality score ($overall_score%) meets threshold"
          fi

  build-test:
    name: Test Jekyll Build
    needs: validate-documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: docs

      - name: Create Gemfile if missing
        run: |
          if [ ! -f docs/Gemfile ]; then
            cat > docs/Gemfile <<'EOF'
          source 'https://rubygems.org'

          gem 'jekyll', '~> 4.3'
          gem 'webrick', '~> 1.8'

          group :jekyll_plugins do
            gem 'jekyll-feed', '~> 0.17'
            gem 'jekyll-seo-tag', '~> 2.8'
            gem 'jekyll-sitemap', '~> 1.4'
            gem 'jekyll-relative-links', '~> 0.7'
            gem 'jekyll-optional-front-matter', '~> 0.3'
            gem 'jekyll-titles-from-headings', '~> 0.5'
            gem 'jekyll-readme-index', '~> 0.3'
            gem 'jekyll-default-layout', '~> 0.1'
          end
          EOF
          fi

      - name: Create Jekyll config if missing
        run: |
          if [ ! -f docs/_config.yml ]; then
            cat > docs/_config.yml <<'EOF'
          title: VisionFlow Documentation
          description: Documentation for VisionFlow XR platform
          markdown: kramdown
          highlighter: rouge

          plugins:
            - jekyll-feed
            - jekyll-seo-tag
            - jekyll-sitemap
            - jekyll-relative-links
            - jekyll-optional-front-matter
            - jekyll-titles-from-headings
            - jekyll-readme-index
            - jekyll-default-layout

          exclude:
            - Gemfile
            - Gemfile.lock
            - scripts/
            - .github/
            - archive/
            - "*.sh"
            - "*.py"
          EOF
          fi

      - name: Install dependencies
        run: |
          cd docs
          bundle install

      - name: Build Jekyll site
        run: |
          cd docs
          bundle exec jekyll build --destination ../_site
        env:
          JEKYLL_ENV: production

      - name: Verify build
        run: |
          chmod +x docs/scripts/verify-build.sh
          docs/scripts/verify-build.sh --site-dir _site

      - name: Upload test build
        uses: actions/upload-artifact@v4
        with:
          name: jekyll-test-build
          path: _site
          retention-days: 7
