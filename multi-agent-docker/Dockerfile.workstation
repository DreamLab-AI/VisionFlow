# CachyOS Workstation for Agentic Flow Development
# Standalone version - installs agentic-flow from npm
# Usage: docker exec -it agentic-flow-cachyos zsh

FROM archlinux:latest

# ===== System Packages =====
RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm \
        base-devel git vim nano \
        zsh curl wget \
        nodejs npm \
        python python-pip \
        xfce4-terminal xorg-server xorg-xinit \
        tigervnc xfce4 xfce4-goodies \
        jq htop ripgrep fd openssh \
    && rm -rf /var/cache/pacman/pkg/*

# ===== Create development user =====
RUN useradd -m -G wheel,video,audio -s /usr/bin/zsh devuser && \
    echo "devuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    mkdir -p /home/devuser/{workspace,models,.config,.cache,logs}

# Switch to development user
USER devuser
WORKDIR /home/devuser

# ===== Install Oh-My-Zsh =====
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended

# ===== Install agentic-flow from npm =====
USER root
RUN npm install -g agentic-flow@latest pm2 gemini-flow claude

# ===== Install Management API =====
COPY --chown=devuser:devuser management-api/package*.json /home/devuser/management-api/
WORKDIR /home/devuser/management-api
RUN npm install --production

COPY --chown=devuser:devuser management-api/ /home/devuser/management-api/
RUN chmod +x /home/devuser/management-api/server.js

# Fix ownership and prepare directories
RUN chown -R devuser:devuser /home/devuser && \
    mkdir -p /app/core-assets

# ===== Copy core assets =====
COPY --chown=devuser:devuser core-assets/ /app/core-assets/

# Switch back to devuser
USER devuser
WORKDIR /home/devuser

# ===== Setup workspace and config =====
RUN mkdir -p ~/workspace ~/models ~/.config/{agentic-flow,claude} ~/.claude-flow/{memory,metrics} ~/.gemini-flow/{swarms,protocols,monitoring}

# ===== Copy configuration files =====
COPY --chown=devuser:devuser config/.zshrc /home/devuser/.zshrc
COPY --chown=devuser:devuser config/router.config.json /home/devuser/.config/agentic-flow/
COPY --chown=devuser:devuser config/mcp.json /home/devuser/.config/claude/mcp.json
COPY --chown=devuser:devuser config/gemini-flow.config.ts /home/devuser/.gemini-flow/production.config.ts

# ===== Install helper scripts =====
COPY --chown=devuser:devuser scripts/ /home/devuser/scripts/
RUN chmod +x /home/devuser/scripts/*.sh

USER root
RUN ln -sf /home/devuser/scripts/mcp-cli.sh /usr/local/bin/mcp
USER devuser

# ===== X11 and Desktop configuration =====
RUN mkdir -p ~/.config/xfce4/xfconf/xfce-perchannel-xml ~/.config/autostart && \
    echo '[Desktop Entry]\nHidden=true' > ~/.config/autostart/xfce4-screensaver.desktop

# ===== Install Python virtual environment and supervisord =====
USER root
RUN python -m venv /opt/venv && \
    /opt/venv/bin/pip install --upgrade pip supervisor websockify \
    google-generativeai \
    youtube_transcript_api \
    httpx \
    google-api-python-client && \
    mkdir -p /usr/share/novnc && \
    git clone --depth 1 https://github.com/novnc/noVNC.git /usr/share/novnc || true

# ===== Install supervisord configuration =====
COPY --chown=root:root config/supervisord.conf /etc/supervisord.conf

USER devuser

# ===== Environment defaults =====
ENV SHELL=/usr/bin/zsh \
    TERM=xterm-256color \
    DISPLAY=:1 \
    ENABLE_DESKTOP=true \
    ENABLE_CODE_SERVER=true \
    ENABLE_GEMINI=true \
    ENABLE_OPENAI=true \
    ENABLE_CLAUDE=true \
    ENABLE_OPENROUTER=true \
    ROUTER_MODE=performance \
    WORKSPACE=/home/devuser/workspace \
    GPU_ACCELERATION=true \
    MCP_AUTO_START=true \
    GEMINI_FLOW_ENABLED=true \
    GEMINI_FLOW_PROTOCOLS=a2a,mcp \
    GEMINI_FLOW_TOPOLOGY=hierarchical \
    GEMINI_FLOW_MAX_AGENTS=66

# ===== Startup script =====
COPY --chown=devuser:devuser scripts/init-workstation.sh /home/devuser/
RUN chmod +x /home/devuser/init-workstation.sh

# ===== Expose ports =====
# 8080: code-server, 6901: noVNC, 9090: Management API, 3000: dev server
EXPOSE 8080 6901 9090 3000

# ===== Volume mount points =====
VOLUME ["/home/devuser/workspace", "/home/devuser/models", "/home/devuser/.claude-flow", "/home/devuser/.config", "/home/devuser/logs"]

# ===== Start with supervisord =====
USER root
CMD ["/opt/venv/bin/supervisord", "-c", "/etc/supervisord.conf"]
