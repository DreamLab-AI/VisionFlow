services:
  comfyui:
    build:
      context: .
      dockerfile: Dockerfile
    image: comfyui-sam3d:latest

    container_name: comfyui
    hostname: comfyui

    # NVIDIA GPU support
    runtime: nvidia
    shm_size: 16gb

    # Resource allocation - generous for heavy model installations
    deploy:
      resources:
        limits:
          memory: 128G
          cpus: '32'
        reservations:
          memory: 16G
          cpus: '8'
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, compute, utility]

    # Network - join ragflow network
    networks:
      docker_ragflow:
        aliases:
          - comfyui.ragflow
          - comfyui.local

    # Port mappings
    ports:
      - "8188:8188"    # ComfyUI Web Interface

    # Volume mounts for persistence
    # Models stored locally in storage-models/ directory (gitignored)
    volumes:
      - ./storage-models:/root/ComfyUI/models:rw
      - ./storage-models/.cache/huggingface:/root/.cache/huggingface:rw
      - comfyui-custom-nodes:/root/ComfyUI/custom_nodes:rw
      - ./storage-output:/root/ComfyUI/output:rw
      - ./storage-input:/root/ComfyUI/input:rw
      - comfyui-user:/root/ComfyUI/user:rw

    # Environment variables
    environment:
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
      CUDA_VISIBLE_DEVICES: "0,1,2"
      CLI_ARGS: ""

    # GPU device access
    devices:
      - /dev/nvidia0:/dev/nvidia0
      - /dev/nvidia1:/dev/nvidia1
      - /dev/nvidia2:/dev/nvidia2
      - /dev/nvidiactl:/dev/nvidiactl
      - /dev/nvidia-uvm:/dev/nvidia-uvm
      - /dev/nvidia-modeset:/dev/nvidia-modeset

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8188"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

    # Restart policy
    restart: unless-stopped

# Networks
networks:
  docker_ragflow:
    external: true
    name: docker_ragflow

# Volumes (models/input/output use host bind mounts)
volumes:
  comfyui-custom-nodes:
    driver: local
  comfyui-user:
    driver: local
