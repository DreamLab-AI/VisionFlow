version: '3.8'

services:
  comfyui:
    build:
      context: .
      dockerfile: Dockerfile.comfyui-open3d
      args:
        BUILDKIT_INLINE_CACHE: 1

    container_name: comfyui
    hostname: comfyui

    # NVIDIA GPU support
    runtime: nvidia
    shm_size: 16gb

    # Resource allocation
    deploy:
      resources:
        limits:
          memory: 32G
          cpus: '16'
        reservations:
          memory: 8G
          cpus: '4'
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, compute, utility]

    # Network - join ragflow network
    networks:
      docker_ragflow:
        aliases:
          - comfyui.ragflow
          - comfyui.local

    # Port mappings
    ports:
      - "8188:8188"    # ComfyUI Web Interface

    # Volume mounts for persistence
    volumes:
      - comfyui-models:/root/ComfyUI/models:rw
      - comfyui-custom-nodes:/root/ComfyUI/custom_nodes:rw
      - comfyui-output:/root/ComfyUI/output:rw
      - comfyui-input:/root/ComfyUI/input:rw
      - comfyui-user:/root/ComfyUI/user:rw

    # Environment variables
    environment:
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
      CLI_ARGS: ""

    # GPU device access
    devices:
      - /dev/nvidia0:/dev/nvidia0
      - /dev/nvidiactl:/dev/nvidiactl
      - /dev/nvidia-uvm:/dev/nvidia-uvm
      - /dev/nvidia-modeset:/dev/nvidia-modeset

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8188"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

    # Restart policy
    restart: unless-stopped

# Networks
networks:
  docker_ragflow:
    external: true
    name: docker_ragflow

# Volumes
volumes:
  comfyui-models:
    driver: local
  comfyui-custom-nodes:
    driver: local
  comfyui-output:
    driver: local
  comfyui-input:
    driver: local
  comfyui-user:
    driver: local
