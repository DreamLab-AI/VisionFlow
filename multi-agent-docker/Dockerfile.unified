# ============================================================================
# Unified CachyOS Development Container
# Combines devpod + multi-agent-docker with multi-user isolation
# ============================================================================

FROM archlinux:latest

# ============================================================================
# PHASE 1: Base System Packages
# ============================================================================

RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm \
        # Core system
        base-devel git vim nano zsh curl wget \
        sudo openssh tmux htop btop ripgrep fd \
        jq yq bat exa fzf \
        # Build dependencies for node-gyp
        python make gcc \
        # Development languages (skip nodejs from pacman, will install v23.11.1 directly)
        python python-pip rustup \
        # Wayland desktop environment (Hyprland)
        hyprland wayvnc kitty \
        xdg-desktop-portal-hyprland \
        qt5-wayland qt6-wayland \
        wl-clipboard grim slurp \
        polkit \
        dunst \
        # Fonts for high contrast 4K display
        ttf-firacode-nerd ttf-liberation ttf-dejavu \
        ttf-font-awesome ttf-hack noto-fonts noto-fonts-emoji \
        # Xorg support for legacy apps (Blender, QGIS)
        xorg-server xorg-xinit xorg-xauth xorg-xwayland xorg-server-xvfb \
        # VNC server and utilities
        x11vnc virtualgl \
        # Window manager and desktop components
        openbox tint2 xfce4-terminal \
        dbus nss freetype2 harfbuzz \
        # Audio/Video
        alsa-lib pipewire pipewire-pulse gtk4 \
        # Graphics
        mesa mesa-utils libva-mesa-driver \
        libglvnd glew freeglut libxcursor libxi libxinerama libxrandr \
        vulkan-icd-loader vulkan-tools \
        chromium firefox \
        # GUI Tools (Blender 5.x installed separately for latest version)
        qgis kicad imagemagick \
        # Python development
        python-virtualenv python-poetry \
        # LaTeX (basic installation - full TeX Live is very large)
        texlive-basic texlive-bin texlive-binextra \
        texlive-fontsrecommended texlive-latexrecommended \
        biber \
        # Additional tools
        docker docker-compose \
        direnv \
    && rm -rf /var/cache/pacman/pkg/*

# Install Node.js v23.11.1 (required for chrome-devtools-mcp compatibility)
RUN curl -fsSL https://nodejs.org/dist/v23.11.1/node-v23.11.1-linux-x64.tar.xz | \
     tar -xJ -C /usr/local --strip-components=1 && \
    npm install -g npm@latest

# ============================================================================
# PHASE 2: NVIDIA Driver Interface + Full CUDA Development Toolkit
# ============================================================================
# NOTE: We do NOT install nvidia-utils here. The nvidia-container-toolkit
# injects host driver libraries at runtime, ensuring version alignment with
# host driver (e.g., 580.105.08). Installing nvidia-utils would cause mismatch.

# Refresh package database and install CUDA stack
# Note: -Syu ensures mirrors are synced before installing
RUN pacman -Syu --noconfirm \
        # OpenGL/Vulkan libraries (driver-agnostic)
        libglvnd \
        vulkan-icd-loader \
        # Core CUDA toolkit (nvcc, ptxas, cuda-gdb, cuobjdump, nvprof, etc.)
        cuda \
        # Deep Neural Network library
        cudnn \
        # Tensor primitives for high-performance computing
        cutensor \
        # NVIDIA profiler
        nsight-compute \
    && rm -rf /var/cache/pacman/pkg/*

# Configure NVIDIA/CUDA environment
# These enable proper GPU detection via nvidia-container-toolkit
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics,display
ENV __GLX_VENDOR_LIBRARY_NAME=nvidia
ENV CUDA_HOME=/opt/cuda
ENV CUDA_PATH=/opt/cuda
ENV CUDA_VERSION=13.0
ENV NVCC_PREPEND_FLAGS='-ccbin /usr/bin/g++'
ENV __NV_PRIME_RENDER_OFFLOAD=1
ENV __VK_LAYER_NV_optimus=NVIDIA_only
ENV LIBGL_ALWAYS_INDIRECT=0

# Global PATH for CUDA and Rust (available to all users and processes)
ENV PATH="/opt/cuda/bin:/usr/lib/rustup/bin:/usr/local/bin:/usr/bin:${PATH}"
ENV LD_LIBRARY_PATH="/opt/cuda/lib64:/opt/cuda/extras/CUPTI/lib64:/usr/lib"

# Ensure GLX uses NVIDIA
RUN mkdir -p /usr/share/glvnd/egl_vendor.d && \
    echo '{"file_format_version":"1.0.0","ICD":{"library_path":"libEGL_nvidia.so.0"}}' \
    > /usr/share/glvnd/egl_vendor.d/10_nvidia.json

# ============================================================================
# PHASE 2.5: Blender 5.x Installation (Latest stable from blender.org)
# ============================================================================

# Download and install Blender 5.0.1 (released Dec 16, 2025)
RUN mkdir -p /opt/blender && \
    curl -fsSL https://download.blender.org/release/Blender5.0/blender-5.0.1-linux-x64.tar.xz | \
    tar -xJ -C /opt/blender --strip-components=1 && \
    ln -s /opt/blender/blender /usr/local/bin/blender && \
    # Install dependencies directly to Blender's Python site-packages (NOT user install)
    # This is critical - Blender's Python doesn't include user site-packages in sys.path
    /opt/blender/5.0/python/bin/python3.11 -m pip install \
        --target=/opt/blender/5.0/python/lib/python3.11/site-packages \
        websockets>=15.0 requests numpy pydantic && \
    # Verify installation
    /opt/blender/5.0/python/bin/python3.11 -c "import websockets; print('websockets:', websockets.__version__)"

# ============================================================================
# PHASE 3: Rust Toolchain Setup
# ============================================================================

RUN rustup default stable && \
    rustup component add rustfmt clippy rust-analyzer && \
    rustup target add wasm32-unknown-unknown

# ============================================================================
# PHASE 4: Multi-User Setup
# ============================================================================

# Create devuser (primary Claude Code user)
RUN useradd -m -u 1000 -G wheel,video,audio,docker -s /usr/bin/zsh devuser && \
    echo "devuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    mkdir -p /home/devuser/{workspace,models,.config,.cache,logs,agents,.claude/skills}

# Create gemini-user (Google Gemini tools)
RUN useradd -m -u 1001 -s /usr/bin/zsh gemini-user && \
    mkdir -p /home/gemini-user/{workspace,.config,.cache}

# Create openai-user (OpenAI Codex tools)
RUN useradd -m -u 1002 -s /usr/bin/zsh openai-user && \
    mkdir -p /home/openai-user/{workspace,.config,.cache}

# Create zai-user (Z.AI service)
RUN useradd -m -u 1003 -s /usr/bin/zsh zai-user && \
    mkdir -p /home/zai-user/{workspace,.config,.cache}

# Configure sudo for devuser to switch to other users
RUN echo "devuser ALL=(gemini-user,openai-user,zai-user) NOPASSWD: ALL" >> /etc/sudoers

# ============================================================================
# PHASE 5: Node.js Global Packages (as root)
# Latest versions for Claude, Claude-Flow, AgentDB, RuVector integration
# ============================================================================

RUN npm install -g \
    @anthropic-ai/claude-code@latest \
    claude-usage-cli@latest \
    claude-flow@latest \
    agentdb@latest \
    ruvector@latest \
    @ruvector/gnn@latest \
    agentic-qe@latest \
    agentic-flow@latest \
    agentic-jujutsu@latest \
    @playwright/mcp@latest \
    pm2@latest \
    typescript@latest \
    ts-node@latest \
    @types/node@latest \
    playwright@latest \
    chrome-devtools-mcp@latest

# Install Playwright browsers (skip system deps - already installed via pacman)
RUN npx -y playwright install chromium

# Clear NPX cache to prevent corruption issues
RUN rm -rf /root/.npm/_npx /home/devuser/.npm/_npx 2>/dev/null || true

# ============================================================================
# PHASE 6: Python Virtual Environment & Tools
# ============================================================================

# Cache bust to force rebuild of Python packages with cu130
ARG REBUILD_PYTHON=2025-12-03-cu130

RUN python -m venv /opt/venv && \
    /opt/venv/bin/pip install --upgrade pip && \
    /opt/venv/bin/pip install \
        torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu130 && \
    /opt/venv/bin/pip install \
        supervisor \
        google-generativeai \
        youtube_transcript_api \
        httpx \
        google-api-python-client \
        anthropic \
        openai \
        numpy pandas scipy matplotlib seaborn \
        scikit-learn jupyter jupyterlab \
        black flake8 mypy pylint \
        pytest pytest-cov \
        requests beautifulsoup4 \
        pyyaml toml \
        huggingface-hub

# Add venv to PATH for supervisor and other Python tools
ENV PATH="/opt/venv/bin:${PATH}"

# ============================================================================
# PHASE 7: devuser Setup (Primary Development User)
# ============================================================================

USER devuser
WORKDIR /home/devuser

# Install Oh-My-Zsh for devuser
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended

# Install uv package manager (skip fish config, use fallback for claude-monitor)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh || true

# Install Rust tools for devuser (as devuser, with proper environment)
USER devuser
ENV PATH="/home/devuser/.cargo/bin:${PATH}"
RUN cargo install bat exa ripgrep fd-find tokei || echo "Rust tools installation skipped"
USER root

# Clone 610+ Claude subagents
RUN cd /home/devuser/agents && \
    git clone --depth 1 https://github.com/ChrisRoyse/610ClaudeSubagents.git temp-agents && \
    mv temp-agents/agents/*.md . && \
    rm -rf temp-agents

USER root

# ============================================================================
# PHASE 8: gemini-user Setup
# ============================================================================

USER gemini-user
WORKDIR /home/gemini-user

# Install Oh-My-Zsh for gemini-user
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended

# Install gemini-flow (will be configured with API key at runtime)
RUN npm install --prefix /home/gemini-user/.local gemini-flow

USER root

# ============================================================================
# PHASE 9: openai-user Setup
# ============================================================================

USER openai-user
WORKDIR /home/openai-user

# Install Oh-My-Zsh for openai-user
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended

# Install OpenAI tools (no --user flag with venv)
RUN /opt/venv/bin/pip install openai || echo "OpenAI install skipped"

USER root

# ============================================================================
# PHASE 10: zai-user Setup (Z.AI Service)
# ============================================================================

USER zai-user
WORKDIR /home/zai-user

# Install Oh-My-Zsh for zai-user
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended

USER root

# ============================================================================
# PHASE 11: Hyprland & Wayland Desktop Configuration
# ============================================================================

# Create Hyprland config directory
RUN mkdir -p /home/devuser/.config/hypr && \
    chown -R devuser:devuser /home/devuser/.config

# Wayvnc password file (same as old VNC)
RUN mkdir -p /home/devuser/.config/wayvnc && \
    echo "turboflow" > /home/devuser/.config/wayvnc/password && \
    chmod 600 /home/devuser/.config/wayvnc/password && \
    chown -R devuser:devuser /home/devuser/.config/wayvnc

# Create XDG runtime directory
RUN mkdir -p /run/user/1000 && \
    chown devuser:devuser /run/user/1000 && \
    chmod 700 /run/user/1000

# ============================================================================
# PHASE 12: SSH Server Configuration
# ============================================================================

RUN mkdir -p /var/run/sshd && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    echo "AllowUsers devuser" >> /etc/ssh/sshd_config

# Set password for devuser (default: turboflow)
RUN echo "devuser:turboflow" | chpasswd

# ============================================================================
# PHASE 13: Copy Application Files
# ============================================================================

# Copy skills (build context is multi-agent-docker/, so paths are relative to that)
COPY --chown=devuser:devuser skills/ /home/devuser/.claude/skills/

# Docker manager and chrome-devtools are already in skills/ directory
# No separate copy needed - they're included in the skills/ copy above

# ============================================================================
# Install MCP Server Dependencies (Node.js-based skills)
# ============================================================================

# Playwright MCP server (consolidated v2.0.0)
RUN cd /home/devuser/.claude/skills/playwright/mcp-server && \
    npm install --production 2>/dev/null || echo "Playwright deps optional" && \
    chmod +x server.js 2>/dev/null || true

# Web-summary MCP server (Python FastMCP v2.0.0 - no npm needed)
# Dependencies installed via pip below

# Jupyter notebooks MCP server
RUN cd /home/devuser/.claude/skills/jupyter-notebooks && \
    npm install --production 2>/dev/null || echo "Jupyter deps optional" && \
    chmod +x server.js 2>/dev/null || true

# ComfyUI MCP server
RUN cd /home/devuser/.claude/skills/comfyui/mcp-server && \
    npm install --production 2>/dev/null || echo "ComfyUI deps optional" && \
    chmod +x server.js 2>/dev/null || true

# Perplexity MCP server
RUN cd /home/devuser/.claude/skills/perplexity/mcp-server && \
    npm install --production 2>/dev/null || echo "Perplexity deps optional" && \
    chmod +x server.js 2>/dev/null || true

# ============================================================================
# Install Python Dependencies for FastMCP Skills
# ============================================================================

# Core MCP and FastMCP dependencies
RUN pip3 install --no-cache-dir --break-system-packages \
    mcp>=1.0.0 \
    pydantic>=2.0.0 \
    httpx>=0.25.0 \
    youtube-transcript-api>=0.6.0

# Docker manager skill
RUN pip3 install --no-cache-dir --break-system-packages \
    docker>=7.0.0

# Jupyter notebook skill
RUN pip3 install --no-cache-dir --break-system-packages \
    ipykernel nbformat

# Web scraping and general utilities
RUN pip3 install --no-cache-dir --break-system-packages \
    beautifulsoup4 requests

# ============================================================================
# Unified Blender MCP Server (Best-in-class 50+ tools)
# ============================================================================

# Install FastMCP and websockets for the bridge
RUN pip3 install --no-cache-dir --break-system-packages \
    "mcp[cli]>=1.3.0" \
    websockets>=12.0 \
    pydantic>=2.0.0

# Create Blender 5.x addon directory and install Unified Blender MCP addon
RUN mkdir -p /home/devuser/.config/blender/5.0/scripts/addons/unified_blender_mcp && \
    cp -r /home/devuser/.claude/skills/blender/addon/* \
       /home/devuser/.config/blender/5.0/scripts/addons/unified_blender_mcp/ && \
    chown -R devuser:devuser /home/devuser/.config/blender

# Create Blender startup script to auto-enable the unified addon
RUN mkdir -p /home/devuser/.config/blender/5.0/scripts/startup && \
    echo 'import bpy\ntry:\n    bpy.ops.preferences.addon_enable(module="unified_blender_mcp")\n    print("[UnifiedMCP] Addon enabled successfully")\nexcept Exception as e:\n    print(f"[UnifiedMCP] Failed to enable: {e}")' \
    > /home/devuser/.config/blender/5.0/scripts/startup/enable_unified_mcp.py && \
    chown -R devuser:devuser /home/devuser/.config/blender

# Make headless start script executable
RUN chmod +x /home/devuser/.claude/skills/blender/scripts/headless_start.py 2>/dev/null || true

# Unified Blender MCP environment variables
ENV BLENDER_WS_HOST=127.0.0.1
ENV BLENDER_WS_PORT=8765
ENV BLENDER_WS_URL=ws://127.0.0.1:8765

# ============================================================================
# Make All MCP Entry Points Executable
# ============================================================================

# Find and chmod all Python and JS files in mcp-server directories
RUN find /home/devuser/.claude/skills -name "*.py" -path "*/mcp-server/*" -exec chmod +x {} \; && \
    find /home/devuser/.claude/skills -name "*.js" -path "*/mcp-server/*" -exec chmod +x {} \; && \
    find /home/devuser/.claude/skills -name "*.py" -path "*/tools/*" -exec chmod +x {} \; && \
    find /home/devuser/.claude/skills -name "*.js" -path "*/tools/*" -exec chmod +x {} \; && \
    chown -R devuser:devuser /home/devuser/.claude/skills

# ============================================================================
# PHASE 14: ComfyUI Installation (GPU-Accelerated Image Generation)
# ============================================================================

USER devuser
WORKDIR /home/devuser

# Clone ComfyUI
RUN git clone https://github.com/comfyanonymous/ComfyUI.git /home/devuser/ComfyUI

# Install ComfyUI with GPU-enabled PyTorch
RUN cd /home/devuser/ComfyUI && \
    python3 -m venv venv && \
    . venv/bin/activate && \
    pip install --upgrade pip && \
    pip install torch torchvision --index-url https://download.pytorch.org/whl/cu124 && \
    pip install -r requirements.txt

# Download FLUX.1-schnell model
RUN cd /home/devuser/ComfyUI && \
    . venv/bin/activate && \
    mkdir -p models/checkpoints && \
    hf download Comfy-Org/flux1-schnell flux1-schnell-fp8.safetensors --local-dir models/checkpoints/ || \
    echo "FLUX model download will be attempted on first run"

# Ensure proper ownership
RUN chown -R devuser:devuser /home/devuser/ComfyUI

USER root

# Copy Full Management API from multi-agent-docker
COPY --chown=devuser:devuser multi-agent-docker/management-api/ /opt/management-api/
RUN cd /opt/management-api && npm install --production && \
    chown -R devuser:devuser /opt/management-api

# Copy Z.AI Service (runs as zai-user on port 9600)
COPY --chown=zai-user:zai-user multi-agent-docker/claude-zai/wrapper/ /opt/claude-zai/
RUN cd /opt/claude-zai && npm install --production && \
    chown -R zai-user:zai-user /opt/claude-zai

# Install code-server using standalone binary method (AUR requires non-root)
RUN mkdir -p /usr/local/lib/code-server && \
    curl -fsSL https://github.com/coder/code-server/releases/download/v4.96.2/code-server-4.96.2-linux-amd64.tar.gz | \
    tar -xz -C /usr/local/lib/code-server --strip-components=1 && \
    ln -s /usr/local/lib/code-server/bin/code-server /usr/bin/code-server

# Install Google Antigravity IDE
RUN mkdir -p /opt/antigravity && \
    curl -fsSL https://edgedl.me.gvt1.com/edgedl/release2/j0qc3/antigravity/stable/1.11.3-6583016683339776/linux-x64/Antigravity.tar.gz | \
    tar -xz -C /opt/antigravity --strip-components=1 && \
    ln -s /opt/antigravity/bin/antigravity /usr/bin/antigravity

# Install gemini-flow globally
RUN npm install -g gemini-flow

# Copy helper scripts (includes generate-mcp-settings.sh for dynamic skill discovery)
COPY --chown=root:root unified-config/scripts/ /usr/local/bin/
RUN chmod 755 /usr/local/bin/*.sh && \
    ls -la /usr/local/bin/generate-mcp-settings.sh 2>/dev/null && \
    echo "âœ“ MCP settings generator installed" || true

# Create SSH directory structure (will be mounted at runtime)
RUN mkdir -p /home/devuser/.ssh && \
    chown devuser:devuser /home/devuser/.ssh && \
    chmod 700 /home/devuser/.ssh

# Copy tmux configuration
COPY --chown=devuser:devuser unified-config/tmux-autostart.sh /home/devuser/.config/tmux-autostart.sh
RUN chmod +x /home/devuser/.config/tmux-autostart.sh

# Copy screensaver disable script
COPY --chown=devuser:devuser unified-config/disable-screensaver.sh /home/devuser/.config/disable-screensaver.sh
RUN chmod +x /home/devuser/.config/disable-screensaver.sh

# Copy terminal autostart script
COPY --chown=devuser:devuser unified-config/autostart-terminals.sh /home/devuser/.config/autostart-terminals.sh
RUN chmod +x /home/devuser/.config/autostart-terminals.sh

# Copy terminal init scripts
COPY --chown=devuser:devuser unified-config/terminal-init/ /home/devuser/.config/terminal-init/
RUN chmod +x /home/devuser/.config/terminal-init/*.sh && \
    ln -sf /home/devuser/.config/terminal-init/init-claude-main.sh /home/devuser/.config/init-claude-main.sh && \
    ln -sf /home/devuser/.config/terminal-init/init-claude-agent.sh /home/devuser/.config/init-claude-agent.sh && \
    ln -sf /home/devuser/.config/terminal-init/init-services.sh /home/devuser/.config/init-services.sh && \
    ln -sf /home/devuser/.config/terminal-init/init-development.sh /home/devuser/.config/init-development.sh && \
    ln -sf /home/devuser/.config/terminal-init/init-docker.sh /home/devuser/.config/init-docker.sh && \
    ln -sf /home/devuser/.config/terminal-init/init-git.sh /home/devuser/.config/init-git.sh && \
    ln -sf /home/devuser/.config/terminal-init/init-gemini.sh /home/devuser/.config/init-gemini.sh && \
    ln -sf /home/devuser/.config/terminal-init/init-openai.sh /home/devuser/.config/init-openai.sh && \
    ln -sf /home/devuser/.config/terminal-init/init-zai.sh /home/devuser/.config/init-zai.sh

# Copy Xorg headless configuration
COPY --chown=root:root unified-config/10-headless.conf /etc/X11/xorg.conf.d/10-headless.conf

# Copy Hyprland configuration
COPY --chown=devuser:devuser unified-config/hyprland.conf /home/devuser/.config/hypr/hyprland.conf

# Copy Kitty terminal configuration
COPY --chown=devuser:devuser unified-config/kitty.conf /home/devuser/.config/kitty/kitty.conf

# Copy CLAUDE.md to both home and workspace (Claude Code reads from workspace)
COPY --chown=devuser:devuser CLAUDE.md /home/devuser/CLAUDE.md
COPY --chown=devuser:devuser CLAUDE.md /home/devuser/workspace/CLAUDE.md

# ============================================================================
# PHASE 14: Supervisord Configuration
# ============================================================================

COPY --chown=root:root unified-config/supervisord.unified.conf /etc/supervisord.conf

# ============================================================================
# PHASE 15: Environment & Runtime Configuration
# ============================================================================

USER devuser

# Set up environment variables in .zshrc
RUN echo '# ============================================' >> ~/.zshrc && \
    echo '# Turbo Flow Environment Configuration' >> ~/.zshrc && \
    echo '# ============================================' >> ~/.zshrc && \
    echo '' >> ~/.zshrc && \
    echo '# Workspace paths' >> ~/.zshrc && \
    echo 'export WORKSPACE=/home/devuser/workspace' >> ~/.zshrc && \
    echo 'export AGENTS_DIR=/home/devuser/agents' >> ~/.zshrc && \
    echo 'export DEVPOD_WORKSPACE_FOLDER=/home/devuser/workspace' >> ~/.zshrc && \
    echo '' >> ~/.zshrc && \
    echo '# CUDA Development Environment' >> ~/.zshrc && \
    echo 'export CUDA_HOME=/opt/cuda' >> ~/.zshrc && \
    echo 'export CUDA_PATH=/opt/cuda' >> ~/.zshrc && \
    echo 'export NVCC_PREPEND_FLAGS="-ccbin /usr/bin/g++"' >> ~/.zshrc && \
    echo '' >> ~/.zshrc && \
    echo '# Comprehensive PATH (CUDA, Rust, local bins)' >> ~/.zshrc && \
    echo 'export PATH="$HOME/.cargo/bin:$HOME/.local/bin:/opt/cuda/bin:/usr/lib/rustup/bin:$PATH"' >> ~/.zshrc && \
    echo 'export LD_LIBRARY_PATH="/opt/cuda/lib64:/opt/cuda/extras/CUPTI/lib64:$LD_LIBRARY_PATH"' >> ~/.zshrc && \
    echo '' >> ~/.zshrc && \
    echo '# Direnv integration' >> ~/.zshrc && \
    echo 'eval "$(direnv hook zsh)"' >> ~/.zshrc && \
    echo '' >> ~/.zshrc && \
    echo '# User switching aliases' >> ~/.zshrc && \
    echo 'alias as-gemini="sudo -u gemini-user -i"' >> ~/.zshrc && \
    echo 'alias as-openai="sudo -u openai-user -i"' >> ~/.zshrc && \
    echo 'alias as-zai="sudo -u zai-user -i"' >> ~/.zshrc && \
    echo '' >> ~/.zshrc && \
    echo '# Claude Code aliases' >> ~/.zshrc && \
    echo 'alias dsp="claude --dangerously-skip-permissions"' >> ~/.zshrc && \
    echo 'alias claude-monitor="~/.cargo/bin/claude-monitor"' >> ~/.zshrc && \
    echo '' >> ~/.zshrc && \
    echo '# CUDA development aliases' >> ~/.zshrc && \
    echo 'alias nvcc-version="nvcc --version"' >> ~/.zshrc && \
    echo 'alias cuda-info="nvidia-smi && echo && nvcc --version"' >> ~/.zshrc && \
    echo 'alias ptx-compile="nvcc -ptx"' >> ~/.zshrc

USER root

# ============================================================================
# PHASE 16: Ports & Volumes
# ============================================================================

# SSH, VNC, code-server, Management API, Z.AI Service
EXPOSE 22 5901 8080 9090 9600

# Volume mount points
VOLUME ["/home/devuser/workspace", \
        "/home/devuser/agents", \
        "/home/devuser/.claude", \
        "/home/gemini-user/workspace", \
        "/home/openai-user/workspace", \
        "/home/devuser/models", \
        "/var/log"]

# ============================================================================
# PHASE 17: Entrypoint
# ============================================================================

COPY --chown=root:root unified-config/entrypoint-unified.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD []
