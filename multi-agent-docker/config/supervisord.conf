[supervisord]
nodaemon=true
logfile=/home/devuser/logs/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=/tmp/supervisord.pid
user=root

[unix_http_server]
file=/tmp/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# =============================================================================
# Desktop Environment (Optional - only if GUI access needed)
# =============================================================================

[program:xvnc]
command=/usr/bin/Xvnc :1 -geometry 1920x1080 -depth 24 -rfbport 5901 -SecurityTypes None -AlwaysShared
user=devuser
autorestart=true
stdout_logfile=/home/devuser/logs/xvnc.log
stderr_logfile=/home/devuser/logs/xvnc.err.log
environment=HOME="/home/devuser"
priority=10
autostart=%(ENV_ENABLE_DESKTOP)s

[program:dbus]
command=/usr/bin/dbus-daemon --session --nofork --nopidfile --address=unix:path=/tmp/dbus-session
user=devuser
autorestart=true
stdout_logfile=/home/devuser/logs/dbus.log
stderr_logfile=/home/devuser/logs/dbus.err.log
environment=DISPLAY=":1",HOME="/home/devuser",DBUS_SESSION_BUS_ADDRESS="unix:path=/tmp/dbus-session"
priority=15
autostart=%(ENV_ENABLE_DESKTOP)s

[program:xfce4]
command=/usr/bin/startxfce4
user=devuser
autorestart=true
stdout_logfile=/home/devuser/logs/xfce4.log
stderr_logfile=/home/devuser/logs/xfce4.err.log
environment=DISPLAY=":1",HOME="/home/devuser",DBUS_SESSION_BUS_ADDRESS="unix:path=/tmp/dbus-session"
priority=20
autostart=%(ENV_ENABLE_DESKTOP)s

[program:novnc]
command=/opt/venv/bin/websockify --web=/usr/share/novnc 6901 localhost:5901
user=devuser
autorestart=true
stdout_logfile=/home/devuser/logs/novnc.log
stderr_logfile=/home/devuser/logs/novnc.err.log
priority=30
autostart=%(ENV_ENABLE_DESKTOP)s

# =============================================================================
# Development Tools (Optional)
# =============================================================================

[program:code-server]
command=/usr/bin/code-server --bind-addr 0.0.0.0:8080 --auth none /home/devuser/workspace
user=devuser
autorestart=true
stdout_logfile=/home/devuser/logs/code-server.log
stderr_logfile=/home/devuser/logs/code-server.err.log
environment=HOME="/home/devuser"
priority=40
autostart=%(ENV_ENABLE_CODE_SERVER)s

# =============================================================================
# Management API - THE ONLY REQUIRED EXTERNAL INTERFACE
# =============================================================================

[program:management-api]
command=/usr/bin/node /home/devuser/management-api/server.js
user=devuser
autorestart=true
stdout_logfile=/home/devuser/logs/management-api.log
stderr_logfile=/home/devuser/logs/management-api.err.log
environment=HOME="/home/devuser",NODE_ENV="production"
priority=50

# =============================================================================
# Session Cleanup (Background maintenance)
# =============================================================================

[program:session-cleanup]
command=/bin/bash -c "while true; do /app/assets/core-assets/scripts/agentic-session-manager.sh cleanup 24 || true; sleep 3600; done"
user=devuser
autorestart=true
stdout_logfile=/home/devuser/logs/session-cleanup.log
stderr_logfile=/home/devuser/logs/session-cleanup.err.log
priority=60

# =============================================================================
# Service Groups
# =============================================================================

[group:desktop]
programs=xvnc,dbus,xfce4,novnc
priority=10

[group:core]
programs=management-api,session-cleanup
priority=50
