# Extension fields for DRY configuration
x-common-environment: &common-environment
  NVIDIA_VISIBLE_DEVICES: ${NVIDIA_VISIBLE_DEVICES:-0}
  NVIDIA_DRIVER_CAPABILITIES: compute,utility
  CUDA_ARCH: ${CUDA_ARCH:-86}
  SYSTEM_NETWORK_PORT: ${SYSTEM_NETWORK_PORT:-4000}
  # MCP and Claude Flow configuration
  CLAUDE_FLOW_HOST: ${CLAUDE_FLOW_HOST:-agentic-workstation}
  MCP_HOST: ${MCP_HOST:-agentic-workstation}
  MCP_TCP_PORT: ${MCP_TCP_PORT:-9500}
  MCP_TRANSPORT: ${MCP_TRANSPORT:-tcp}
  MCP_RECONNECT_ATTEMPTS: ${MCP_RECONNECT_ATTEMPTS:-3}
  MCP_RECONNECT_DELAY: ${MCP_RECONNECT_DELAY:-1000}
  MCP_CONNECTION_TIMEOUT: ${MCP_CONNECTION_TIMEOUT:-30000}
  ORCHESTRATOR_WS_URL: ${ORCHESTRATOR_WS_URL:-ws://mcp-orchestrator:9001/ws}
  MCP_RELAY_FALLBACK_TO_MOCK: ${MCP_RELAY_FALLBACK_TO_MOCK:-true}
  BOTS_ORCHESTRATOR_URL: ${BOTS_ORCHESTRATOR_URL:-ws://agentic-workstation:3002}
  MANAGEMENT_API_HOST: ${MANAGEMENT_API_HOST:-agentic-workstation}
  MANAGEMENT_API_PORT: ${MANAGEMENT_API_PORT:-9090}
  # JavaScript Solid Server (JSS) configuration
  JSS_URL: ${JSS_URL:-http://jss:3030}
  JSS_WS_URL: ${JSS_WS_URL:-ws://jss:3030/.notifications}

x-common-healthcheck: &common-healthcheck
  test: ["CMD", "curl", "-f", "http://localhost:4000/api/health"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s

x-common-logging: &common-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-gpu-resources: &gpu-resources
  resources:
    reservations:
      devices:
        - driver: nvidia
          count: 1
          capabilities: [gpu, compute, utility]

services:
  # Neo4j Graph Database - Required for all profiles
  neo4j:
    container_name: visionflow-neo4j
    image: neo4j:5.13.0
    environment:
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
      - NEO4J_server_memory_pagecache_size=512M
      - NEO4J_server_memory_heap_max__size=1G
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - neo4j-conf:/conf
      - neo4j-plugins:/plugins
    networks:
      - docker_ragflow
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    logging:
      <<: *common-logging

  # JavaScript Solid Server (JSS) - Federated Solid Pods
  # Provides: LDP CRUD, JSON-LD native storage, WebSocket notifications,
  # Nostr NIP-98 auth, Web Access Control (WAC), content negotiation
  jss:
    container_name: visionflow-jss
    build:
      context: ./JavaScriptSolidServer
      dockerfile: Dockerfile.jss
    environment:
      - JSS_PORT=3030
      - JSS_HOST=0.0.0.0
      - JSS_ROOT=/data
      - JSS_NOTIFICATIONS=true
      - JSS_CONNEG=true
      - JSS_MULTIUSER=true
      - JSS_IDP=false
    volumes:
      - jss-data:/data
    ports:
      - "${JSS_PORT:-3030}:3030"
    networks:
      - docker_ragflow
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3030/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    logging:
      <<: *common-logging
    profiles:
      - development
      - dev
      - production
      - prod

  # Unified VisionFlow service with profile-based configuration
  visionflow:
    container_name: ${CONTAINER_NAME:-visionflow_container}
    hostname: ${HOSTNAME:-webxr}
    depends_on:
      neo4j:
        condition: service_healthy
    build:
      context: .
      dockerfile: ${DOCKERFILE:-Dockerfile.unified}
      target: development
      args:
        CUDA_ARCH: ${CUDA_ARCH:-86}
        BUILD_TARGET: ${BUILD_TARGET:-development}
    env_file:
      - .env
    environment:
      <<: *common-environment
      # Development-specific variables (overridden in production profile)
      NODE_ENV: ${NODE_ENV:-development}
      VITE_DEBUG: ${DEBUG_ENABLED:-true}
      VITE_DEV_SERVER_PORT: ${VITE_DEV_SERVER_PORT:-5173}
      VITE_API_PORT: ${VITE_API_PORT:-4000}
      VITE_HMR_PORT: ${VITE_HMR_PORT:-24678}
      RUST_LOG: ${RUST_LOG:-debug}
      RUST_LOG_REDIRECT: ${RUST_LOG_REDIRECT:-true}
      DOCKER_ENV: ${DOCKER_ENV:-true}
      # Neo4j Configuration
      NEO4J_URI: ${NEO4J_URI:-bolt://neo4j:7687}
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}
      NEO4J_DATABASE: ${NEO4J_DATABASE:-neo4j}
    volumes:
      # Data volumes - ALWAYS mounted (both dev and prod)
      - visionflow-data:/app/data
      - visionflow-logs:/app/logs
      # SOURCE CODE MOUNTS - Live sync from host for development hot-reload
      # These override the COPY'd source in the image with current host files
      - ./src:/app/src:ro
      - ./Cargo.toml:/app/Cargo.toml:ro
      - ./Cargo.lock:/app/Cargo.lock:ro
      - ./build.rs:/app/build.rs:ro
      - ./whelk-rs:/app/whelk-rs:ro
      - ./client/src:/app/client/src:ro
      - ./client/public:/app/client/public:ro
      - ./client/index.html:/app/client/index.html:ro
      - ./client/vite.config.ts:/app/client/vite.config.ts:ro
      - ./client/tsconfig.json:/app/client/tsconfig.json:ro
      # Cache volumes for build optimization
      - npm-cache:/root/.npm
      - cargo-cache:/root/.cargo/registry
      - cargo-git-cache:/root/.cargo/git
      - cargo-target-cache:/app/target
      # Docker socket for controlled access (development only)
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Mount host data directory for graph content
      - ./data/markdown:/workspace/ext/data/markdown:ro
      - ./data/metadata:/workspace/ext/data/metadata:rw
    ports:
      # Development: Nginx entry point + API port
      - "${DEV_NGINX_PORT:-3001}:3001"
      - "${API_PORT:-4000}:4000"
    networks:
      docker_ragflow:
        aliases:
          - ${NETWORK_ALIAS:-webxr}
    deploy:
      <<: *gpu-resources
    runtime: nvidia
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s
    logging:
      <<: *common-logging
    profiles:
      - development
      - dev

  # Production profile configuration
  visionflow-production:
    container_name: ${CONTAINER_NAME:-visionflow_prod_container}
    hostname: ${HOSTNAME:-webxr-prod}
    depends_on:
      neo4j:
        condition: service_healthy
    build:
      context: .
      dockerfile: Dockerfile.production
      args:
        CUDA_ARCH: ${CUDA_ARCH:-86}
        BUILD_TARGET: production
        REBUILD_PTX: ${REBUILD_PTX:-false}
    env_file:
      - .env
    environment:
      <<: *common-environment
      # Production-specific overrides
      NODE_ENV: production
      RUST_LOG: ${RUST_LOG:-warn}
      GIT_HASH: ${GIT_HASH:-production}
      VITE_DEBUG: "false"
      # Neo4j Configuration
      NEO4J_URI: ${NEO4J_URI:-bolt://neo4j:7687}
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}
      NEO4J_DATABASE: ${NEO4J_DATABASE:-neo4j}
    volumes:
      # Production: ONLY data volumes (no source mounts, no Docker socket)
      - visionflow-data:/app/data
      - visionflow-logs:/app/logs
    ports:
      # Production: Only API port
      - "${PROD_API_PORT:-3001}:3001"
    networks:
      docker_ragflow:
        aliases:
          - ${NETWORK_ALIAS:-webxr}
    deploy:
      <<: *gpu-resources
      resources:
        limits:
          memory: 8G
          cpus: '4'
        reservations:
          memory: 2G
          cpus: '1'
    runtime: nvidia
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      <<: *common-logging
    profiles:
      - production
      - prod

  # Cloudflare tunnel - works with both profiles
  cloudflared:
    container_name: ${CLOUDFLARED_CONTAINER:-cloudflared-tunnel}
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    volumes:
      - ./config.yml:/etc/cloudflared/config.yml:ro
    depends_on:
      visionflow:
        condition: service_started
        required: false
      visionflow-production:
        condition: service_started
        required: false
    networks:
      - docker_ragflow
    restart: unless-stopped
    logging:
      <<: *common-logging
    profiles:
      - development
      - dev
      - production
      - prod

networks:
  docker_ragflow:
    external: true
    name: ${EXTERNAL_NETWORK:-docker_ragflow}

volumes:
  # Persistent data volumes
  visionflow-data:
    name: ${DATA_VOLUME_NAME:-visionflow-data}
    driver: local
  visionflow-logs:
    name: ${LOGS_VOLUME_NAME:-visionflow-logs}
    driver: local
  # Build cache volumes
  npm-cache:
    name: ${NPM_CACHE_VOLUME:-visionflow-npm-cache}
    driver: local
  cargo-cache:
    name: ${CARGO_CACHE_VOLUME:-visionflow-cargo-cache}
    driver: local
  cargo-git-cache:
    name: ${CARGO_GIT_CACHE_VOLUME:-visionflow-cargo-git-cache}
    driver: local
  cargo-target-cache:
    name: ${CARGO_TARGET_CACHE_VOLUME:-visionflow-cargo-target-cache}
    driver: local
  # Neo4j volumes
  neo4j-data:
    name: ${NEO4J_DATA_VOLUME:-visionflow-neo4j-data}
    driver: local
  neo4j-logs:
    name: ${NEO4J_LOGS_VOLUME:-visionflow-neo4j-logs}
    driver: local
  neo4j-conf:
    name: ${NEO4J_CONF_VOLUME:-visionflow-neo4j-conf}
    driver: local
  neo4j-plugins:
    name: ${NEO4J_PLUGINS_VOLUME:-visionflow-neo4j-plugins}
    driver: local
  # JavaScript Solid Server data volume
  jss-data:
    name: ${JSS_DATA_VOLUME:-visionflow-jss-data}
    driver: local
