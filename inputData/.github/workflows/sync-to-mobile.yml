name: Sync Graph to Mobile Branch

on:
  push:
    branches:
      - main
    paths:
      - 'mainKnowledgeGraph/**'

jobs:
  sync-graph-to-mobile:
    runs-on: ubuntu-latest
    name: Initialize/update mobile branch with private graph subset
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure mobile branch exists and add worktree
        run: |
          git fetch origin

          if git ls-remote --heads origin mobile | grep -q 'refs/heads/mobile'; then
            echo "âœ… Mobile branch already exists on remote"
          else
            echo "ðŸ†• Creating mobile branch from main"
            git branch mobile
            git push origin mobile
          fi

          # Ensure local tracking branch and worktree
          git fetch origin mobile:mobile
          # Remove existing worktree directory if present from previous runs
          rm -rf mobile-temp
          git worktree add mobile-temp mobile

      - name: Select non-public pages for mobile
        run: |
          cd mainKnowledgeGraph/pages

          # Build list of pages that are NOT public
          : > /tmp/non-public-pages.txt

          for file in *.md; do
            [ -f "$file" ] || continue

            is_public=0

            # Public marker at top of file
            if head -1 "$file" | grep -q "^public:: true"; then
              is_public=1
            # OntologyBlock with public-access:: true
            elif grep -q "^- ### OntologyBlock" "$file" && grep -q "public-access:: true" "$file"; then
              is_public=1
            fi

            if [ $is_public -eq 0 ]; then
              echo "$file" >> /tmp/non-public-pages.txt
            fi
          done

          count=$(wc -l < /tmp/non-public-pages.txt 2>/dev/null || echo 0)
          echo "âœ… Selected $count non-public pages for mobile"

      - name: Populate mobile branch with private graph subset
        run: |
          cd mobile-temp

          # Keep only mainKnowledgeGraph subtree in the mobile branch
          for entry in *; do
            if [ "$entry" != "mainKnowledgeGraph" ]; then
              rm -rf "$entry"
            fi
          done

          # Ensure expected directories exist
          mkdir -p mainKnowledgeGraph/pages
          mkdir -p mainKnowledgeGraph/journals
          mkdir -p mainKnowledgeGraph/logseq
          mkdir -p mainKnowledgeGraph/whiteboards

          # Clear existing content
          rm -f mainKnowledgeGraph/pages/*.md 2>/dev/null || true
          rm -f mainKnowledgeGraph/journals/*.md 2>/dev/null || true
          rm -rf mainKnowledgeGraph/logseq/* 2>/dev/null || true
          rm -rf mainKnowledgeGraph/whiteboards/* 2>/dev/null || true

          # Copy non-public pages from main
          while IFS= read -r page; do
            if [ -f "../mainKnowledgeGraph/pages/$page" ]; then
              cp "../mainKnowledgeGraph/pages/$page" "mainKnowledgeGraph/pages/"
            fi
          done < /tmp/non-public-pages.txt

          # Copy all journals from main
          if ls ../mainKnowledgeGraph/journals/*.md >/dev/null 2>&1; then
            cp ../mainKnowledgeGraph/journals/*.md mainKnowledgeGraph/journals/
          fi

          # Copy Logseq config
          if [ -d "../mainKnowledgeGraph/logseq" ]; then
            cp -r ../mainKnowledgeGraph/logseq/* mainKnowledgeGraph/logseq/ 2>/dev/null || true
          fi

          # Copy whiteboards
          if [ -d "../mainKnowledgeGraph/whiteboards" ]; then
            cp -r ../mainKnowledgeGraph/whiteboards/* mainKnowledgeGraph/whiteboards/ 2>/dev/null || true
          fi

          echo "ðŸ“‚ mainKnowledgeGraph structure on mobile:"
          find mainKnowledgeGraph -maxdepth 2 -type d | sed 's/^/  - /'

          echo "ðŸ“„ Non-public pages on mobile: $(ls mainKnowledgeGraph/pages/*.md 2>/dev/null | wc -l)"
          echo "ðŸ““ Journals on mobile: $(ls mainKnowledgeGraph/journals/*.md 2>/dev/null | wc -l)"

      - name: Commit and push to mobile branch
        run: |
          cd mobile-temp
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -A

          if git diff --staged --quiet; then
            echo "No changes to commit on mobile branch"
          else
            git commit -m "Sync private graph subset to mobile" \
              -m "Includes non-public pages, journals, logseq config, and whiteboards under mainKnowledgeGraph." \
              -m "ðŸ¤– Generated by GitHub Actions"
            git push origin mobile
          fi