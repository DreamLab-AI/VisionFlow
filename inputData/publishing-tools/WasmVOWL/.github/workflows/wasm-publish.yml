name: WasmVOWL Build and Test

on:
  push:
    branches:
      - main
      - develop
      - 'claude/**'
    paths:
      - 'publishing-tools/WasmVOWL/**'
      - '.github/workflows/wasm-publish.yml'
  pull_request:
    paths:
      - 'publishing-tools/WasmVOWL/**'
      - '.github/workflows/wasm-publish.yml'
  workflow_dispatch:

env:
  RUST_VERSION: stable
  NODE_VERSION: '20'
  WASM_SIZE_LIMIT_MB: 1.5

jobs:
  version-check:
    name: Version Synchronization Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify version sync
        run: |
          cd publishing-tools/WasmVOWL
          chmod +x scripts/check-versions.sh
          ./scripts/check-versions.sh

  rust-wasm-build:
    name: Build Rust WASM Module
    runs-on: ubuntu-latest
    needs: version-check

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            publishing-tools/WasmVOWL/rust-wasm/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build WASM package
        run: |
          cd publishing-tools/WasmVOWL/rust-wasm
          wasm-pack build --target web --release

      - name: Verify WASM binary size
        run: |
          cd publishing-tools/WasmVOWL/rust-wasm
          WASM_FILE="pkg/webvowl_wasm_bg.wasm"

          if [[ ! -f "$WASM_FILE" ]]; then
            echo "âŒ WASM file not found: $WASM_FILE"
            exit 1
          fi

          # Get file size in MB
          SIZE_BYTES=$(stat -f%z "$WASM_FILE" 2>/dev/null || stat -c%s "$WASM_FILE")
          SIZE_MB=$(echo "scale=2; $SIZE_BYTES / 1048576" | bc)

          echo "ðŸ“¦ WASM binary size: ${SIZE_MB}MB"

          # Check against limit
          if (( $(echo "$SIZE_MB > $WASM_SIZE_LIMIT_MB" | bc -l) )); then
            echo "âŒ WASM binary exceeds size limit!"
            echo "   Current: ${SIZE_MB}MB"
            echo "   Limit: ${WASM_SIZE_LIMIT_MB}MB"
            exit 1
          fi

          echo "âœ… WASM binary size within limits (${SIZE_MB}MB / ${WASM_SIZE_LIMIT_MB}MB)"

      - name: Verify WASM package structure
        run: |
          cd publishing-tools/WasmVOWL/rust-wasm
          echo "ðŸ“¦ Verifying WASM package contents..."

          REQUIRED_FILES=(
            "pkg/webvowl_wasm_bg.wasm"
            "pkg/webvowl_wasm.js"
            "pkg/webvowl_wasm.d.ts"
            "pkg/package.json"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "âŒ Required file missing: $file"
              exit 1
            fi
            echo "âœ… Found: $file"
          done

          echo "âœ… WASM package structure verified"

      - name: Run Rust tests
        run: |
          cd publishing-tools/WasmVOWL/rust-wasm
          cargo test --all-features

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-package
          path: publishing-tools/WasmVOWL/rust-wasm/pkg/
          retention-days: 7

  frontend-build:
    name: Build Frontend Application
    runs-on: ubuntu-latest
    needs: rust-wasm-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: publishing-tools/WasmVOWL/modern/package-lock.json

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-package
          path: publishing-tools/WasmVOWL/rust-wasm/pkg/

      - name: Copy WASM package to node_modules
        run: |
          cd publishing-tools/WasmVOWL
          echo "ðŸ“¦ Installing WASM package into node_modules..."

          # Create target directory
          mkdir -p modern/node_modules/narrativegoldmine-webvowl-wasm

          # Copy WASM package files
          cp -r rust-wasm/pkg/* modern/node_modules/narrativegoldmine-webvowl-wasm/

          # Verify installation
          if [[ ! -f "modern/node_modules/narrativegoldmine-webvowl-wasm/webvowl_wasm_bg.wasm" ]]; then
            echo "âŒ WASM file not found in node_modules after copy"
            exit 1
          fi

          echo "âœ… WASM package installed to node_modules"

      - name: Install frontend dependencies
        run: |
          cd publishing-tools/WasmVOWL/modern
          npm ci

      - name: Run TypeScript type checking
        run: |
          cd publishing-tools/WasmVOWL/modern
          npm run type-check

      - name: Run linting
        run: |
          cd publishing-tools/WasmVOWL/modern
          npm run lint

      - name: Run frontend tests
        run: |
          cd publishing-tools/WasmVOWL/modern
          npm run test

      - name: Build production bundle
        run: |
          cd publishing-tools/WasmVOWL/modern
          npm run build

      - name: Verify build output
        run: |
          cd publishing-tools/WasmVOWL/modern

          if [[ ! -d "dist" ]]; then
            echo "âŒ Build output directory 'dist' not found"
            exit 1
          fi

          if [[ ! -f "dist/index.html" ]]; then
            echo "âŒ index.html not found in build output"
            exit 1
          fi

          # Get build size
          DIST_SIZE=$(du -sh dist | cut -f1)
          echo "ðŸ“¦ Build output size: $DIST_SIZE"
          echo "âœ… Build verification passed"

      - name: Validate WASM files in build
        run: |
          cd publishing-tools/WasmVOWL/modern
          echo "ðŸ” Searching for WASM files in build output..."

          WASM_FILES=$(find dist -name "*.wasm" -type f)

          if [[ -z "$WASM_FILES" ]]; then
            echo "âš ï¸  Warning: No .wasm files found in dist/"
            echo "   This may be expected if WASM is dynamically loaded"
            echo "   Checking for WASM module references..."

            # Check for WASM module references in JS files
            if grep -r "webvowl_wasm" dist/ >/dev/null 2>&1; then
              echo "âœ… Found WASM module references in JS bundle"
            else
              echo "âŒ No WASM references found in build output"
              exit 1
            fi
          else
            echo "âœ… Found WASM files in build:"
            echo "$WASM_FILES" | while read -r file; do
              SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
              SIZE_KB=$(echo "scale=2; $SIZE / 1024" | bc)
              echo "  - $file (${SIZE_KB}KB)"
            done
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: publishing-tools/WasmVOWL/modern/dist/
          retention-days: 7

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [rust-wasm-build, frontend-build]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-package
          path: publishing-tools/WasmVOWL/rust-wasm/pkg/

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: publishing-tools/WasmVOWL/modern/dist/

      - name: Run integration tests
        run: |
          cd publishing-tools/WasmVOWL
          echo "âœ… Integration tests placeholder (to be implemented)"

  publish-summary:
    name: Publish Build Summary
    runs-on: ubuntu-latest
    needs: [version-check, rust-wasm-build, frontend-build, integration-test]
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate summary
        run: |
          echo "# WasmVOWL Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Version info
          CARGO_VERSION=$(grep '^version = ' publishing-tools/WasmVOWL/rust-wasm/Cargo.toml | head -n1 | sed 's/version = "\(.*\)"/\1/')
          echo "**Version:** v$CARGO_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Jobs" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Version Check: ${{ needs.version-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Rust WASM Build: ${{ needs.rust-wasm-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Frontend Build: ${{ needs.frontend-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Integration Tests: ${{ needs.integration-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- WASM package available for download" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend dist bundle available for download" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
